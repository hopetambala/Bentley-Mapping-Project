
<!-- to render map: enter the following into the command prompt:
python3 -m http.server

then, direct to the following on your browser:
http://localhost:8000/
 -->


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Redacted</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" media="screen, print" rel="stylesheet">

    <!-- leaflet cluster example 03.09.2018 -->
    <link rel="stylesheet" type="text/css" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.css" />
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.Default.css" />

    <script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js'></script>
    <script type='text/javascript' src='http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js'></script>
    <script type='text/javascript' src='http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster.js'></script>

    <!-- Pass the geojson data into a viarable named GEOJSON -->
    <script type="text/javascript" src="data/vlookup.js"></script>

    <!--former script links pre 03.09.2018 -->
    <!-- <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>


    <!-- Time range slider -->
    <link rel="stylesheet" href="jquery-ui-1.12.1.custom/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="jquery-ui-1.12.1.custom/jquery-ui.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <!-- New  Crossfilter libraries-->
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/dc@3/dc.css" />
    <script src="https://unpkg.com/d3@5/dist/d3.js"></script>
    <script src="https://unpkg.com/crossfilter2@1.4/crossfilter.js"></script>
    <script src="https://unpkg.com/dc@3/dc.js"></script>
    <script src="https://rawgit.com/crossfilter/reductio/master/reductio.js"></script>

    <link rel="stylesheet" type="text/css" href="./style.css">
</head>



<body>
    <!-- time range slider -->
    <div class="sliderDiv" >
        <p>
            <label for="amount">Time range for Accommodations:</label>
            <input class="sliderValue" type="text" id="amount" >
        </p>
        <!--div id="slider-range"></div-->
        <!-- Create a div where the new slider will be -->
        <svg width=400 height=400 id="slider-range"></svg>
    </div>

    <!-- opacity slider -->
    <div class="sliderDiv narrow" >
        <p>
            <label for="opacity">Map opacity:</label>
            <input class="sliderValue" type="text" id="opacity" >
        </p>
        <div id="slider-opaque"></div>
    </div>

    <!-- checkboxes -->
    <span class="filterCheckBox">
        <label class="checkBoxContainer">Accommodations
          <input type="checkbox" name="Accommodations" value="accommodation_markers" checked=true>
          <span class="checkmark accommodation_marker"></span>
        </label>
        <label class="checkBoxContainer">Events
          <input type="checkbox" name="Events"  value="event_markers" checked=true>
          <span class="checkmark event_marker"></span>
        </label>
        <!-- <input type="checkbox" name="Accommodations" value="accommodation_markers" checked=true> Accommodations
        <input type="checkbox" name="Events"  value="event_markers" checked=true> Events -->
    </span>



    <hr>

    <h1>African-American UofM Student Residences<h1>
    <h3>1853-1973 (approx)</h3>

    <div id="map"></div>

    <!-- Manipulate the map -->
    <script type="text/javascript">

        //Method 2
        const markColors = {
            'residence': '#4E91BE', 
            'event': '#F99E4C'
        };

        var customizedIcon;
        /*
            Customize Marker
        */
        function customizeMarker(color){
            const myCustomColour = color

            const markerNarrativeHtmlStyles = `
                background-color: ${myCustomColour};
                width: 1.2rem;
                height: 1.2rem;
                display: block;
                left: -1.2rem;
                top: -1.2rem;
                position: relative;
                border-radius: 3rem 3rem 0;
                transform: rotate(45deg);
                border: 0.5px solid #FFFFFF
            `

            var icon = L.divIcon({
                className: "my-custom-pin",
                iconAnchor: [0, 24],
                labelAnchor: [-6, 0],
                popupAnchor: [0, -36],
                html: `<span style="${markerNarrativeHtmlStyles}" />`
            })

            return icon;
        }



        /*
            Marker Clusters
            1 for residence
            2 for events
        */
        function initialMarkerClusters(type){

            var uniqueClass;

            var groupToReturn = new L.markerClusterGroup({
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: true,
                zoomToBoundsOnClick: true,
                // maxClusterRadius: 120,
                singleMarkerMode: false,
                iconCreateFunction: function(cluster){
                    count = 0;
                    cluster.getAllChildMarkers().forEach(function(child){
                        count = (type == 1) ? (count + parseInt(child.feature.properties.Count)) : (count + 1);
                    });
                    return L.divIcon({
                        className:`marker-cluster ${uniqueClass}`,
                        iconSize: new L.Point(40,40),
                        html: `<div><span >` + count + '</span></div>'
                    });
                }
            })

            switch (type) {
                case 1:
                    uniqueClass = "marker-cluster-large";
                    groupToReturn.options.maxClusterRadius = 120;
                    break;
                case 2:
                    uniqueClass = "marker-cluster-large_nav";
                    groupToReturn.options.maxClusterRadius = 1;
            }

            return groupToReturn;
        }

        /*
            Renders Markers to map
            - Takes in 
            2 for events
        */
        function renderPins(accommodation_markers, geoJson){
            customizedIcon = customizeMarker(markColors['residence']);

            var geojson = L.geoJson(geoJson,
            {
                onEachFeature: function(feature,layer){
                    layer.bindPopup("<b>Address:  </b>" + feature.properties.address + "<br>" + "<b>No. of Students:  </b>" + feature.properties.Count);
                },
                pointToLayer: function (feature, latlng) {
                    return L.marker(latlng, {icon: customizedIcon});
                }
            });

            accommodation_markers.clearLayers();
            accommodation_markers.addLayer(geojson);
            map.addLayer(accommodation_markers);
        }

        function renderNarrativePins(event_markers, geoJsonURL){
            customizedIcon = customizeMarker(markColors['event']);

            $.getJSON(geoJsonURL, function(data){
                var geojson = L.geoJson(data, {
                        onEachFeature: function(feature,layer){
                            let val_date = feature.properties.Date;
                            let val_text = feature.properties.Text;
                            let val_keywords = feature.properties.Keywords;
                            let val_img = feature.properties['Local_Image'];

                            if (val_date != ""){
                                val_date = "<b>Date: </b>" + val_date + "<br>";
                            }

                            if (val_text != ""){
                                val_text = "<b>Text: </b>" + val_text  + "<br>";
                            }

                            if (val_keywords != ""){
                                val_keywords = "<b>Keywords: </b>" + val_keywords + "<br>";
                            }

                            if (val_img != ""){
                                val_img = '<img src="' + val_img + '"  style="max-width:250; max-height:200" />';
                            }

                            layer.bindPopup("<b>Address:  </b>" + feature.properties.Address + "<br>" + val_date + val_text + val_keywords + val_img);
                        },

                        pointToLayer: function (feature, latlng) {
                            return L.marker(latlng, {icon: customizedIcon});
                        }
                });
                event_markers.addLayer(geojson);
                map.addLayer(event_markers);
            });

        }

       

        //Slider
        $( function() {
            // Config opaque slider
            $( "#slider-opaque" ).slider({
                range: false,
                min: 0,
                max: 1,
                step: 0.1,
                value: 1,

                slide: function( event, ui ) {
                    let opaque = ui.value;

                    $( "#opacity" ).val( opaque );
                    a2_1916_02.setOpacity(opaque);
                }
            });

            //initial display
            $( "#opacity" ).val("1");
           
            //Replace this with a cross filter graph
            // config time range slider
            /*$( "#slider-range" ).slider({
                range: true,
                min: 1853, //change to year 1853
                max: 1973, //change to year 1973
                values: [ 1853, 1973 ], //change to year 1853 - 1973

                // Every time slider is slided, the map should be refreshed
                slide: function( event, ui ) {

                    var newGeoJson = {
                        "type" : "Feature Collection",
                        "features": []
                    };
                    let startYear = ui.values[ 0 ];
                    let endYear = ui.values[ 1 ];

                    $( "#amount" ).val( startYear + " - " + endYear );

                    //Only markers that are pushed to be shown are markers with the required properties
                    for (let i = 0; i < GEOJSON["features"].length; i++){
                        if (GEOJSON["features"][i]["properties"]["Date"] >= startYear && GEOJSON["features"][i]["properties"]["Date"] <= endYear) {  // will change "id" to "year"
                            newGeoJson["features"].push(GEOJSON["features"][i])
                        }
                    }
                    renderPins(accommodation_markers,newGeoJson);
                }
            }); */
            var geoChart  = dc.barChart("#slider-range");
            // use static or load via d3.csv("spendData.csv", function(error, spendData) {/* do stuff */});

            min = 1853 //change to year 1853
            max = 1973 //change to year 1973
            /*var spendData = [
                {Name: 'Mr A', Spent: '$40', Year: 2011},
                {Name: 'Mr B', Spent: '$10', Year: 2011},
                {Name: 'Mr C', Spent: '$40', Year: 2011},
                {Name: 'Mr A', Spent: '$70', Year: 2012},
                {Name: 'Mr B', Spent: '$20', Year: 2012},
                {Name: 'Mr B', Spent: '$50', Year: 2013},
                {Name: 'Mr C', Spent: '$30', Year: 2013}
            ];*/
            var geoData = GEOJSON["features"]
            //console.log(spendData)
            // normalize/parse data
            geoData.forEach(function(d) {
                //d.Spent = d.Spent.match(/\d+/);
                d.properties.Count = +d.properties.Count
                //console.log(d.properties.Count)
            });
            // set crossfilter
            var ndx = crossfilter(geoData),
                yearDim  = ndx.dimension(function(d) {return +d.properties.Date;}),
                countDim = ndx.dimension(function(d) {return d.properties.Count;}),
                nameDim  = ndx.dimension(function(d) {return d.properties.address;}),
                countPerYear = yearDim.group().reduceSum(function(d) {return +d.properties.Count;}),
                countPerName = nameDim.group().reduceSum(function(d) {return +d.properties.Count;}),
                countHist    = countDim.group().reduceCount();

            geoChart
                .dimension(countPerYear)
                .group(countHist)
                .x(d3.scaleLinear().domain([0,20]))
                .elasticY(true)
                .controlsUseVisibility(true);

            geoChart.xAxis().tickFormat(function(d) {return d}); // convert back to base unit
            geoChart.yAxis().ticks(2);

            dc.renderAll();
            
            //initial display
            $( "#amount" ).val(
                 $( "#slider-range" ).slider( "values", 0 ) + " - " + $( "#slider-range" ).slider( "values", 1 )
            );
        } );


        // RENDER THE MAP
        // use a variable for the 1920 tile set
        var a2_mod = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});

        // Rheagan's piece: use a variable for the 1920 tile set
        var OpenStreetMap_BlackAndWhite = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        // Rheagan's piece - adding sanbourn maps
        var a2_1916_02 = L.tileLayer('http://mapwarper.net/maps/tile/28881/{z}/{x}/{y}.png');
        var histmap = L.layerGroup([a2_1916_02]);

        var map = L.map('map', {
            layers: [OpenStreetMap_BlackAndWhite, histmap]
        });

        var overlayMaps = {
            "show historic map": histmap
        };

        L.control.layers(null, overlayMaps).addTo(map);

        // zoom and center in Ann Arbor
        map.setView([42.2718, -83.7436], 14);

        // cluster points on the map
        var accommodation_markers = initialMarkerClusters(1);
        var event_markers = initialMarkerClusters(2);
        var markers = {
            "accommodation_markers": accommodation_markers,
            "event_markers": event_markers
        }

        //GET THE INITIAL PINS
        renderPins(accommodation_markers, GEOJSON);

        renderNarrativePins(event_markers, "data/final_narrative_data.geojson");



        d3.selectAll("input[type=checkbox]").on("change", function(d) {
            var showPins = this.checked;
            var theMarker = markers[this.value];

            if(showPins){
                map.addLayer(theMarker);
            } else{
                map.removeLayer(theMarker);
            }
        });

    
        

    </script>


</body>
